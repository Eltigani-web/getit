name: Release

on:
  release:
    types: [published]

env:
  REGISTRY: docker.io
  IMAGE_NAME: eltiganiweb/getit

jobs:
  pypi-publish:
    name: Upload release to PyPI
    runs-on: ubuntu-latest
    environment: pypi
    permissions:
      id-token: write
    outputs:
      version: ${{ steps.version.outputs.version }}
      wheel_sha256: ${{ steps.checksum.outputs.sha256 }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install build hatch-vcs

      - name: Get version from tag
        id: version
        run: |
          VERSION="${GITHUB_REF#refs/tags/v}"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Version: $VERSION"

      - name: Build package
        run: python -m build

      - name: Calculate wheel checksum
        id: checksum
        run: |
          python -c "
          import sys
          import hashlib
          from pathlib import Path
          
          wheels = list(Path('dist').glob('*.whl'))
          if len(wheels) == 0:
              print('::error::No wheel files found in dist/', file=sys.stderr)
              sys.exit(1)
          elif len(wheels) > 1:
              print(f'::error::Multiple wheel files found: {[w.name for w in wheels]}', file=sys.stderr)
              sys.exit(1)
          
          wheel = wheels[0]
          sha256 = hashlib.sha256(wheel.read_bytes()).hexdigest()
          
          with open('$GITHUB_OUTPUT', 'a') as f:
              f.write(f'sha256={sha256}\n')
          
          print(f'Wheel SHA256: {sha256}')
          "

      - name: Publish package distributions to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1

  docker-publish:
    name: Build and push Docker image
    runs-on: ubuntu-latest
    needs: pypi-publish
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=raw,value=latest,enable=${{ startsWith(github.ref, 'refs/tags/') }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            VERSION=${{ needs.pypi-publish.outputs.version }}

      - name: Verify Docker image
        run: |
          docker pull "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.pypi-publish.outputs.version }}"
          docker run --rm "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.pypi-publish.outputs.version }}" --version

  homebrew-publish:
    name: Update Homebrew formula
    runs-on: ubuntu-latest
    needs: pypi-publish
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}

      - name: Update Homebrew formula
        run: |
          VERSION="${{ needs.pypi-publish.outputs.version }}"
          SHA256="${{ needs.pypi-publish.outputs.wheel_sha256 }}"

          FORMULA_FILE=".homebrew-tap/Formula/getit.rb"

          if [ -f "$FORMULA_FILE" ]; then
            # Replace placeholders
            sed -i "s|{{VERSION}}|${VERSION}|g" "$FORMULA_FILE"
            sed -i "s|{{SHA256}}|${SHA256}|g" "$FORMULA_FILE"
            
            # Replace existing version line (url with actual version)
            sed -i "s|url \"https://files.pythonhosted.org/packages/.*/getit_cli-[0-9.]*-py3-none-any.whl\"|url \"https://files.pythonhosted.org/packages/...placeholder.../getit_cli-${VERSION}-py3-none-any.whl\"|g" "$FORMULA_FILE"
            
            # Replace existing sha256 line
            sed -i "s|sha256 \"[a-f0-9]\{64\}\"|sha256 \"${SHA256}\"|g" "$FORMULA_FILE"
            
            cat "$FORMULA_FILE"
          else
            echo "::warning::Formula file not found at $FORMULA_FILE, skipping Homebrew update"
          fi

      - name: Commit and push formula update
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if [ -f ".homebrew-tap/Formula/getit.rb" ]; then
            git add .homebrew-tap/Formula/getit.rb
            if git diff --staged --quiet; then
              echo "No changes to commit"
            else
              git commit -m "chore: Update getit formula to ${{ needs.pypi-publish.outputs.version }}"
              if ! git push origin HEAD:main; then
                echo "::error::Failed to push formula update"
                exit 1
              fi
            fi
          fi

      - name: Sync to homebrew-tap repository
        if: ${{ vars.HOMEBREW_TAP_REPO != '' }}
        uses: cpina/github-action-push-to-another-repository@v1.7.2
        env:
          SSH_DEPLOY_KEY: ${{ secrets.HOMEBREW_TAP_DEPLOY_KEY }}
        with:
          source-directory: '.homebrew-tap'
          destination-github-username: ${{ github.repository_owner }}
          destination-repository-name: 'homebrew-getit'
          target-branch: main
          commit-message: "chore: Update getit formula to ${{ needs.pypi-publish.outputs.version }}"
